## 값 타입



JPA의 데이터 타입 분류 

* 엔티티 타입

  @Entity로 정의하는 객체

  데이터 변해도 식별자로 지속 추적 (pk로)

* 값 타임 

  * 기본 값 타입
  * 임베디드 타입 
  * 컬렉션 값 타입



#### 기본값 타입

String name, int age 등의 기본 데이터 타입

생명주기를 엔티티에 의존 -> 공유하면 안됨 

int doulbe 같은건 공유되지 않음 (call by value라서)

근데 Integer 같은 래퍼 클래스들은 공유 가능 (call by reference) -> 근데 바꾸는게 안됨



#### 임베디드 타입

새로운 타입 정의 : 기본 값 타입을 모아서 -> 복합 값 타입으로

DB상에서 임베디드 타입을 사용하기 전/후로 매핑하는 테이블은 같음

단지 세밀하게 매핑하는 것이 가능

사용법

@Embeddable : 정의하는 곳에 표시

@Embedded : 사용하는 곳에 표시

기본 생성자 필수

장점

1. 재사용 가능
2. 높은 응집도
3. 해당 값 타임만 사용하는 의미 있는 메소드 사용 가능
4. 모든 값 타입은 소유한 엔티티와 생명주기를 의존

한 엔티티 내에서 같은 값 타입을 사용하는 경우 -> 컬럼명이 중복되어버림

@AttributeOverride 등을 사용해서 컬럼 명 속성을 재정의

임베디드 타입 값이 null이면 -> 매핑한 컬럼 값 다 null



#### 값 타입

값 타입은 복찹한 객체 세상을 단순하려고 만든 개념 -> 단순하고 안전하게 다룰 수 있어야 함

임베디드 타입 같은 값 타입을 여러 엔티티에서 공유하면 위험

> A , B가  -> 임베디드 address를 참조 = address 변경시 A,B 둘 다 바뀜

그래서 복사해서 사용해야 함 -> 근데 누가 실수로 안함

> 컴파일러 레벨에서 이 문제를 절대 찾을 수 없음



그래서 객체 타입을 수정할 수 없게 만들어야 함. (원천 차단)

-> 불변 객체로 만들기 (Setter를 만들지 말기 or Private으로 만들기)

> ex) Integer, String



#### 값 타입 비교

값 타입은 인스턴스 달라도 안에 값이 같으면 같은 것으로

> a = 10, b = 10 이면 a,b에 상관없이 10이면 같음



반면 인스턴스 타입은 == 사용해도 다른 클래스면 다르게 뜸

* 동일성 비교 : 참조 값이 같은지 '=='
* 동등성 비교 : 인스턴스의 값을 비교 'equals'

값 타입은 equals를 통해서 값을 비교 -> equals를 override해서 사용해야 함 (hashCode도 함께 구현)



#### 값 타입 컬렉션

1:N의 관계인 경우 -> Set이나 List 사용

@ElementCollection, @CollectionTable 사용

DB는 컬렉션을 같은 테이블에 저장할 수 없기 때문에, 저장하기 위한 별도의 테이블 필요

> 예외적으로 컬럼이 1개인 경우에는 그냥 Column만 사용해도 됨

* 값 타입 컬렉션은 기본이 지연 로딩 (당연히 지연로딩으로)

* 값 타입은 CASCADE + orphan기능을 필수로 가진다고 할 수 있음



값 타입 수정은 set을 막아버림 (불변객체로 하기로 함)

-> 아예 인스턴스 자체를 새로 끼워넣어버리기



콜렉션에서는 -> 걍 삭제하고 새로 넣기

> equals로 콜렉션 내부를 비교해서 remove, add하기 때문에 equals 구현이 필수적

근데 쿼리 동작을 보면, 테이블을 다 비우고 -> 다시 다 삽입하는 과정임



#### 값 타입 제약사항

엔티티와 다르게 식별자x -> 변경시 추적 힘듦

변경 사항이 발생하면 -> 주인과 관련된 무든 데이터 삭제 -> 이후 컬렉션 내의 값을 모두 다시 저장

그리고 매핑 테이블은 모든 컬럼을 묶어서 기본 키를 구성해야함 -> null x 중복 x



**결론** : 실무에서는 그냥 일대다 관계 엔티티 만들고 값 타입 사용, 컬렉션 안쓰기 + cascade, 고아객체 제거

아주아주 단순하고, update할 필요도 없을때 값 타입 컬렉션 쓰기

-> 만약 식별자가 필요하고 지속적으로 추적하고, 변경해야 한다면 그건 엔티티