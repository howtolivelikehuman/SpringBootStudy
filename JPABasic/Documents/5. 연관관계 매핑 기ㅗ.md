회원 / 팀 ==> 회원은 팀에 소속 / 팀에는 여러 회원이 있음

회원이 팀의 id 를 직접 가지고 있는 경우

1. 외래키 식별자를 직접 다루는게 애매
2. 조회하는 경우 연관관계가 없기 때문에 계속 팀 id를 조회해야함

-> 너무 다름 (테이블은 외래키 조인 / 객체는 참조)



#### 단방향 연관관계

한명만이 참조 가능

아예 객체는 Team을 들고있어버리자.

이때 1 : N 등의 관계는 DB관점으로생각 (멤버는 Many, 팀은 One -> ManyToOne)

이후 JoinColumn으로 팀에서 무슨 컬럼을 참조할지 선택 (Team의 기본키)



#### 양방향 연관관계

회원에서 팀을 찾기는 쉬움. 근데 팀에서 회원을 찾고 싶을 수도 있음.



테이블에서는 그냥 팀 PK를 멤버에 찾게 돌리면 쉽게 얻어낼 수 있음

근데 객체에서는 불가능 -> Team에 members List를 만들어줘야함.

멤버-> 팀이 ManyToOne이니깐, 역으로는 OneToMany, mappedBy로 뭐와 연관되었는지도 설정해주기.



문제점

> 객체는 사실상 단방향 2개.
>
> 테이블에서는 1개로 양방향 가능. (외래키로)
>
> -> 그래서 어떻게 객체를 양방향이 되게 2개 만듦.
>
> -> 만약 회원이 바뀌었을 때, 회원에서 바꿔야하냐 아니면 팀의 회원리스트에서 바꿔야하나
>
> -> 외래키를 결국 누가 관리하냐가 문제.

= 연관관계 주인 등장



두 관계중 주인을 정하고, 주인이 외래키 관리 (등록, 수정 가능) / 상대방은 읽기만 가능!

mappedBy로 주인을 가르키기.

-> 그럼 누구를 주인으로 하냐? = 테이블에서 외래키가 있는 애

"1:N에서 외래키 = 1의 기본키 = N이 주인

왜?

> 외래키 없는 애(팀)이 회원을 고침 -> 자기 테이블도 아닌 애가 바뀌게 됨.



#### 양방향 매핑에서 실수

1. 연관관계 주인에 값을 입력하지 않음.

   > 팀에서 회원을 등록해버림.  (읽기전용이라 쿼리로 들어가짐)
   >
   > 외래키 저장은 회원테이블 -> 회원이 주인 -> 회원에서 팀을 등록해야함.
   >
   > 굳이 팀에 세팅 안해놔도, JPA에서 이후에 회원을 찾을 때 알아서 찾아줌.

   추가문제)

   > 근데, 영속성 컨텍스트가 유지되고 있었다면 ? (1차 캐시에 팀이 계속 있음)
   >
   > -> 메모리에만 있음 -> JPA에서 DB에서 조회 안함 -> 팀에서는 회원 못찾음
   >
   > 특히 테스트케이스 작성 시 문제

   -> 양방향 연관관계면 그냥 양쪽에 값을 다 세팅해주자.

   > 까먹을 수 있으니 연관관계 편의 메소드를 짜놓자. (set할때 자동으로 양쪽 다 되게)

   

2. 양방향 매핑시 무한 루프 조심

   > member.toString -> team.toString 호출 -> 또 member....
   >
   > JSON 생성 라이브러리, lombok 등에서도 문제 발생 가능
   >
   > -> Response에서 직접 Entity를 보내는 경우 주로 문제 발생

   -> lombok에서 toString 만들지 말기.

   -> Controller에서는 Entity 절대 쓰지마라.

   > 무한루프 문제 외에도 Entity가 변경 ->  API 스펙 변경 -> 프론트 머리 파괴
   >
   > DTO를 쓰세요. Entity를 Service에서 쓸지 Repository에서 쓸지는 케바케

   

#### 

#### 결론

설계는 애초에 단방향으로 연관관계 매핑을 끝내야함.

-> 양방향은 단순히 반대로 조회하는 기능

-> JPQL을 사용하다보면 역방향으로 탐색할 일이 많음

-> 필요할 때 그때그때 추가하세요. (이때 해도 DB 테이블에는 영향이 없으니깐)



주인 정할때는 **외래 키** 기준으로 하기

(만약에 역으로도 수정하고 싶으면, 편의 메소드를 만들어서 쓰세요)

